<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="opencc.js" defer></script>
    <title>æ–½å·¥å“è³ªæª¢æŸ¥-AIç”Ÿæˆå¼è¼”åŠ©ç³»çµ± - é›™æ¨¡ç‰ˆæœ¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 85%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: visible;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,.3);
        }

        .header p { font-size: 1.1rem; opacity: .9; }

        .type-selector {
            background: rgba(255,255,255,.2);
            border-radius: 15px;
            padding: 20px; margin: 20px 0;
        }

        .type-buttons {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
        }

        .type-btn {
            background: rgba(255,255,255,.9);
            color: #1e3c72; border: none; padding: 10px 20px;
            border-radius: 25px; cursor: pointer; font-weight: bold;
            transition: all .3s ease;
        }
        .type-btn:hover { background: rgb(228,237,186); box-shadow: 0 5px 15px rgba(0,0,0,.2); }
        .type-btn.active { background: #28a745; color: #fff; }

        .add-type-section { background: rgba(255,255,255,.1); border-radius: 10px; padding: 15px; margin-top: 15px; }

        .checklist-upload { display: flex; gap: 10px; align-items: center; margin-top: 10px; }

        .checklist-input {
            flex: 1; padding: 8px; border: 1px solid rgba(255,255,255,.3); border-radius: 5px;
            --progress: 0%; --progress-color: rgba(23,162,184,.35);
            background: linear-gradient(90deg,
                    var(--progress-color) 0%,
                    var(--progress-color) var(--progress),
                    rgba(255,255,255,.08) var(--progress),
                    rgba(255,255,255,.05) 100%);
            color: white; transition: background .3s ease, color .3s ease;
        }
        .checklist-input::placeholder { color: rgba(255,255,255,.7); }
        .checklist-input.checklist-progress-active { font-weight: 600; color: #0d1b2a; position: relative; overflow: hidden; }
        .checklist-input.checklist-progress-error { color: #fff; }
        .checklist-input:disabled { cursor: progress; }

        .upload-checklist-btn {
            background: #17a2b8; color: white; border: none; padding: 8px 15px;
            border-radius: 5px; cursor: pointer; font-weight: bold; transition: background .3s ease, opacity .3s ease;
        }
        .upload-checklist-btn:disabled { background: #6c757d; cursor: not-allowed; opacity: .7; }

        .type-btn-container { position: relative; display: inline-block; }
        .type-btn-actions { position: absolute; top: -8px; right: -8px; display:flex; gap: 2px; }
        .type-btn-container:hover .type-btn-actions { display: flex; }
        .action-btn { width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer; font-size: 12px; display:flex; align-items:center; justify-content:center; }
        .edit-btn { background: #ffc107; color: #212529; }
        .delete-btn { background: #dc3545; color: #fff; }
        .action-btn:hover { transform: scale(1.1); }

        .edit-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,.7); z-index:1000; }
        .edit-modal-content { position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); background:#fff; border-radius:15px; padding:30px; max-width:800px; max-height:80vh; overflow-y:auto; box-shadow: 0 20px 40px rgba(0,0,0,.3); }
        .edit-modal h3 { margin-bottom:20px; color:#2c3e50; }
        .edit-item { background:#f8f9fa; border-radius:10px; padding:15px; margin-bottom:15px; border:1px solid #dee2e6; }
        .edit-item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .edit-item input, .edit-item textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:5px; margin-bottom:10px; }
        .edit-item textarea { resize: vertical; min-height:60px; }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }
        .modal-btn { padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        .save-btn { background:#28a745; color:#fff; }
        .cancel-btn { background:#6c757d; color:#fff; }
        .add-item-btn { background:#007bff; color:#fff; width:100%; padding:10px; margin-bottom:15px; }

        @media (max-width:768px){
            .main-content{ gap:20px; padding:20px; }
            .config-container{ flex-direction:column; }
            .upload-section{ flex:1 1 100%; }
            .preview-section{ min-height:200px; }
            .preview-image{ max-height:40vh; }
            .type-buttons{ justify-content:flex-start; flex-wrap:wrap; }
            .type-btn{ font-size:.9rem; padding:8px 15px; }
            .edit-modal-content{ max-width:95%; padding:20px; }
        }

        .api-section { background:#1e025746; border:1px solid #ffc107; border-radius:10px; padding:15px 20px; transition: all .3s ease; flex: 1 1 320px; }
        .api-section.collapsed{ padding:10px 20px; }
        .api-title{ font-size:1.2rem; color:#9ce94b; margin-bottom:0; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:space-between; }
        .api-title:hover{ color:#b22222; background:linear-gradient(135deg,#fbe3e3 0%,#f9dede 100%); box-shadow:0 0 8px rgba(178,34,34,.2); }
        .api-toggle{ font-size:1rem; margin-left:10px; transition: transform .3s ease; }
        .api-content{ max-height:200px; overflow:hidden; transition:max-height .3s ease, margin-top .3s ease; margin-top:15px; }
        .api-content.collapsed{ max-height:0; margin-top:0; }
        .api-input-group{ display:flex; gap:10px; align-items:center; }
        .api-input{ flex:1; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:.9rem; }
        .api-save-btn{ background:#28a745; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold; }
        .api-status{ margin-top:10px; padding:8px; border-radius:5px; font-size:.9rem; }
        .api-status.success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .api-status.error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

        .main-content{ display:flex; flex-direction:column; gap:30px; padding:30px; align-items:stretch; }

        .upload-section{
            display:flex; flex-direction:row; justify-content:space-between; align-items:center;
            background:#f8f9fa; border-radius:15px; padding:25px; border:2px dashed #dee2e6;
            transition:all .3s ease; gap:20px; max-height:none; position:static;
        }
        .upload-area{ flex:1; text-align:center; padding:40px 20px; cursor:pointer; border-radius:10px; transition:all .3s ease; background:rgba(255,255,255,.6); }
        .upload-area:hover{ background: rgba(0,123,255,.1); }

        .preview-section{ flex:1; display:flex; align-items:center; justify-content:center; min-height:250px; }
        .preview-section.show{ display:flex; }
        .preview-image{ max-width:100%; max-height:400px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,.2); object-fit:contain; }

        .analysis-section{ background:#fff; border-radius:15px; padding:25px; box-shadow:0 5px 15px rgba(0,0,0,.1); }

        .upload-icon{ font-size:3rem; color:#6c757d; margin-bottom:15px; }
        .upload-text{ font-size:1.2rem; color:#495057; margin-bottom:10px; }
        .upload-hint{ font-size:.9rem; color:#6c757d; }

        #fileInput{ display:none; }

        .model-selector{ display:flex; align-items:center; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
        .checklist-model-toggle{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
        .checklist-model-toggle .toggle-label{ font-weight:bold; color:#ffffff; }

        .model-label{ font-weight:bold; color:#2c3e50; }
        .model-btn{ background:rgba(255,255,255,.85); border:1px solid #d1d9ff; border-radius:20px; padding:6px 16px; cursor:pointer; font-size:.9rem; color:#314c83; transition:all .3s ease; }
        .model-btn:hover{ background: rgba(103,126,234,.15); box-shadow:0 4px 10px rgba(49,76,131,.2); }
        .model-btn.active{ background: linear-gradient(135deg,#28a745 0%,#20c997 100%); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(32,201,151,.3); }
        .model-btn:disabled{ background: rgba(200,205,220,.6); color: rgba(49,76,131,.4); border-color: rgba(209,217,255,.5); cursor:not-allowed; box-shadow:none; }

        .analysis-title{ font-size:1.5rem; color:#2c3e50; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #3498db; }

        .inspection-items{ margin-bottom:20px; }
        .inspection-item{ background:#f8f9fa; border-radius:10px; padding:15px; margin-bottom:10px; border-left:4px solid #6c757d; cursor:pointer; transition:all .3s ease; }
        .inspection-item:hover{ background:#e6e5e9; transform: translateX(5px); }
        .inspection-item.selected{ border-left-color:#28a745; background:#d4edda; }
        .inspection-item.defect{ border-left-color:#dc3545; background:#f8d7da; }
        .item-name{ font-weight:bold; color:#2c3e50; }
        .item-standard{ font-size:.9rem; color:#6c757d; line-height:1.4; margin-top:6px; }

        /* æª¢æŸ¥é …ç›®ç·¨è™Ÿå¾½ç«  */
        .item-head{
          display:flex; align-items:center; gap:10px; margin-bottom:6px;
        }
        .item-index{
          min-width:28px; height:28px; line-height:28px; text-align:center;
          border-radius:999px; font-weight:700; font-size:.9rem;
          background:#e9ecef; color:#495057; border:1px solid #dee2e6;
          flex:0 0 28px;
        }
        .inspection-item.defect .item-index{
          background:#f8d7da; color:#721c24; border-color:#f5c6cb;
        }
        .inspection-item.selected .item-index{
          background:#d4edda; color:#155724; border-color:#c3e6cb;
        }

        .analyze-btn{
            background: linear-gradient(135deg,#28a745 0%,#20c997 100%); color:#fff;
            border:none; padding:15px 30px; border-radius:25px; font-size:1.1rem; font-weight:bold;
            cursor:pointer; transition: all .3s ease; width:100%; margin-top:20px;
        }
        .analyze-btn:hover{ transform: translateY(-2px); box-shadow:0 10px 20px rgba(40,167,69,.3); }
        .analyze-btn:disabled{ background:#6c757d; cursor:not-allowed; transform:none; box-shadow:none; }

        .loading{ display:none; text-align:center; padding:20px; }
        .loading-text{ font-weight:600; letter-spacing:.08em; color: rgba(12,49,105,.9); display:inline-flex; align-items:center; gap:6px; }
        .loading-text .loading-icon{ font-size:1.2rem; animation: loadingIconSpin 1.4s linear infinite; }
        @keyframes loadingIconSpin{ 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
        .spinner{ border:3px solid #f3f3f3; border-top:3px solid #3498db; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin:0 auto 15px; }
        @keyframes spin{ 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

        /* æ–°å¢æª¢æŸ¥é¡å‹ç”¨çš„å°å‹æ—‹è½‰åœˆåœˆï¼ˆæ–°å¢ï¼‰ */
        .spinner-mini{
          display:none;
          width:16px; height:16px;
          border:3px solid rgba(255,255,255,.35);
          border-top-color:#17a2b8;
          border-radius:50%;
          animation: spin 1s linear infinite;
          vertical-align: middle;
          margin-left:8px;
        }

        .ai-badge{
            background: linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%);
            color:#fff; padding:5px 15px; border-radius:20px; font-size:.8rem; font-weight:bold; display:inline-block; margin-left:10px;
        }

        /* åˆ†æçµæœå¼·åŒ–æ¨£å¼ */
        .result-section{ display:none; margin-top:25px; padding:20px; background: linear-gradient(135deg,#fff3cd 0%,#ffeaa7 100%); border-radius:15px; border:1px solid #ffc107; }
        .result-title{ font-size:1.3rem; color:#856404; margin-bottom:15px; font-weight:bold; }
        .result-content{ color:#333; line-height:1.6; }

        .analysis-list{ list-style:none; padding:0; margin:20px 0 0 0; display:flex; flex-direction:column; gap:12px; }
        .analysis-item{ display:flex; gap:15px; align-items:flex-start; background: rgba(240,248,255,.65); border-left:4px solid #2196f3; border-radius:12px; padding:15px 18px; box-shadow: 0 6px 12px rgba(0,0,0,.06); }
        .analysis-item.analysis-primary{ background: rgba(227,242,253,.95); }
        .analysis-item.analysis-warning{ background: rgba(255,243,205,.9); border-left-color:#ffc107; }
        .analysis-item.analysis-success{ background: rgba(232,245,232,.9); border-left-color:#4caf50; }
        .analysis-item.analysis-accent{ background: rgba(255,243,224,.9); border-left-color:#ff9800; }
        .analysis-icon{ font-size:1.6rem; line-height:1; }
        .analysis-content{ flex:1; }
        .analysis-title-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
        .analysis-title{ font-weight:700; margin-bottom:8px; color:#1e3c72; font-size:1.05rem; }
        .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; margin-left:6px; }
        .pill-high{ background:#dc3545; color:#fff; }
        .pill-med{ background:#ffc107; color:#212529; }
        .pill-low{ background:#28a745; color:#fff; }

        .mini-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; margin-top:6px; }
        .mini-card{ background:#fff; border:1px dashed #e0e0e0; border-radius:10px; padding:10px; font-size:.92rem; }

        .collapse{ border:none; background:transparent; cursor:pointer; font-size:.9rem; color:#0d6efd; }
        .collapsed .collapse-icon{ transform: rotate(-90deg); }
        .collapse-icon{ display:inline-block; transition: transform .2s ease; }

        .detail-block{ background:#fff; border:1px solid #eee; border-radius:12px; padding:14px; margin-top:10px; }
        .detail-block h4{ margin-bottom:8px; color:#1e3c72; font-size:1rem; }

        @media (max-width:768px){
            .analysis-title-row{ flex-direction:column; align-items:flex-start; gap:6px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ç‡Ÿå»ºå·¥ç¨‹æ–½å·¥å“è³ªæª¢æŸ¥è¼”åŠ©ç³»çµ±<span class="ai-badge">AIæ·±åº¦è¾¨è­˜åˆ†æ</span></h1>
        <p>ä½¿ç”¨AIæ¨¡å‹ï¼Œä¾æ“šæª¢æŸ¥é …ç›®èˆ‡æª¢æŸ¥æ¨™æº–æ™ºèƒ½åˆ†æç¾å ´æ–½å·¥ç…§ç‰‡</p>

        <div class="type-selector">
            <h3 style="color: white; margin-bottom: 15px; text-align: center;"> é¸æ“‡æª¢æŸ¥é¡å‹</h3>
            <div class="type-buttons" id="typeButtons"></div>

            <div class="add-type-section">
                <div style="color: white; margin-bottom: 10px; font-weight: bold;">æ–°å¢æª¢æŸ¥é¡å‹</div>
                <div class="model-toggle checklist-model-toggle">
                    <span class="toggle-label">è§£ææ¨¡å‹ï¼š</span>
                    <button type="button" class="model-btn active" data-checklist-provider="cloud" onclick="selectChecklistProvider('cloud')">â˜ï¸ Claude é›²ç«¯</button>
                    <button type="button" class="model-btn" data-checklist-provider="local" onclick="selectChecklistProvider('local')">ğŸ’» Ollama æœ¬åœ°</button>
                </div>
                <div class="checklist-upload">
                    <input type="text" class="checklist-input" id="checklistName" placeholder="å¯è¼¸å…¥è‡ªè¨‚æª¢æŸ¥é¡å‹åç¨±ï¼ˆä¾‹å¦‚ï¼šæ··å‡åœŸæ¾†ï¼Œä½†åªèƒ½ä¸Šå‚³å½±åƒæª”ï¼‰">
                    <input type="file" id="checklistInput" accept="image/*" style="display: none;">
                    <button class="upload-checklist-btn" id="uploadChecklistBtn" onclick="triggerChecklistUpload()">ä¸Šå‚³æª¢æŸ¥è¡¨</button>
                </div>
                <div id="checklistStatus" style="margin-top: 10px; font-size: 0.9rem;"></div>
                <!-- å°å‹æ—‹è½‰åœˆåœˆï¼ˆæ–°å¢æª¢æŸ¥é¡å‹æµç¨‹ç”¨ï¼‰ -->
                <span id="checklistSpinner" class="spinner-mini" aria-label="loading"></span>
            </div>
            <div class="api-section" id="apiSection">
                <div class="api-title" style="cursor: default;">Claude.ai API è¨­å®š</div>
                <div class="api-content" id="apiContent" style="margin-top: 15px;">
                    <div class="api-input-group">
                        <!-- 5) JSï¼šæ”¾å¯¬ API Key é©—è­‰è¦å‰‡ï¼ˆé¿å…èª¤æ®ºï¼‰ é€™ä¸€æ®µä¸è¦ä¿®æ”¹ -->
                        <input type="password" id="apiKey" class="api-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„Claude APIå¯†é‘° (sk-ant-api03-...)" value="">
                        <button class="api-save-btn" onclick="saveApiKey()">å„²å­˜</button>
                    </div>
                    <div id="apiStatus" class="api-status" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="config-container">
            <div class="upload-section">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“¸</div>
                    <div class="upload-text">é»æ“Šä¸Šå‚³ç…§ç‰‡</div>
                    <div class="upload-hint">æ”¯æ´ JPG, PNG, GIF æ ¼å¼ â€¢ AIå°‡åˆ†æç…§ç‰‡å…§å®¹</div>
                </div>
                <input type="file" id="fileInput" accept="image/*">
                <div class="preview-section" id="previewSection">
                    <img id="previewImage" class="preview-image" alt="é è¦½åœ–ç‰‡">
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <div class="analysis-title" id="analysisTitle">ğŸ“‹ æª¢æŸ¥é …ç›® <span style="font-size: 0.8rem; color: #6c757d;">â€¢ AIå°‡è‡ªå‹•è­˜åˆ¥ç›¸é—œé …ç›®</span></div>

            <div class="model-selector" id="modelSelector">
                <span class="model-label">åˆ†ææ¨¡å‹ï¼š</span>
                <button type="button" class="model-btn active" data-provider="cloud" onclick="selectAnalysisProvider('cloud')">â˜ï¸ Claude é›²ç«¯</button>
                <button type="button" class="model-btn" data-provider="local" onclick="selectAnalysisProvider('local')">ğŸ’» Ollama æœ¬æ©Ÿ</button>
            </div>

            <div class="inspection-items" id="inspectionItems"></div>

            <button class="analyze-btn" id="analyzeBtn" onclick="analyzeImageWithAI()" disabled>ğŸ” AIç¼ºå¤±æª¢æŸ¥</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">
                    <span class="loading-icon">ğŸ”„</span>
                    <span id="loadingText">æ­£åœ¨è§£ææª¢æŸ¥è¡¨...</span>
                </div>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-title">AIåˆ†æçµæœ</div>
                <div class="result-content" id="resultContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯æ¨¡æ…‹è¦–çª— -->
<div id="editModal" class="edit-modal">
    <div class="edit-modal-content">
        <h3 id="editModalTitle">ç·¨è¼¯æª¢æŸ¥é …ç›®</h3>
        <button class="modal-btn add-item-btn" onclick="addNewItem()">â• æ–°å¢æª¢æŸ¥é …ç›®</button>
        <div id="editItemsContainer"></div>
        <div class="modal-actions">
            <button class="modal-btn save-btn" onclick="saveEditedItems()">ğŸ’¾ å„²å­˜</button>
            <button class="modal-btn cancel-btn" onclick="closeEditModal()">âŒ å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
/* -------------------- ç‹€æ…‹èˆ‡è®Šæ•¸ -------------------- */
let uploadedImage = null;
let apiKey = null;
let currentInspectionType = 'rebar';
let inspectionTypesData = null;
let analysisProvider = 'cloud';
let checklistProvider = 'cloud';

const checklistProgress = { input: null, originalValue: '', active: false, timer: null };
let loadingTextTimer = null;
let loadingBaseText = 'æ­£åœ¨è§£ææª¢æŸ¥è¡¨';

/* -------------------- é€²åº¦æ¢ï¼šæ–°å¢æª¢æŸ¥é¡å‹ -------------------- */
function beginChecklistProgress(message, percent){
    const input = checklistProgress.input; if(!input) return;
    if(!checklistProgress.active){ checklistProgress.originalValue = input.value; checklistProgress.active = true; }
    input.disabled = true;
    input.classList.add('checklist-progress-active');
    updateChecklistProgress(message, percent);
}
function updateChecklistProgress(message, percent){
    const input = checklistProgress.input; if(!input) return;
    input.value = message;
    const clamped = Math.max(0, Math.min(100, percent));
    input.dataset.progress = clamped;
    input.style.setProperty('--progress', `${clamped}%`);
    input.style.setProperty('--progress-color', 'rgba(23, 162, 184, 0.6)');
}
function completeChecklistProgress(message){
    const input = checklistProgress.input; if(!input) return;
    input.value = message;
    input.dataset.progress = 100;
    input.style.setProperty('--progress', '100%');
    input.style.setProperty('--progress-color', 'rgba(40, 167, 69, 0.75)');
    clearTimeout(checklistProgress.timer);
    checklistProgress.timer = setTimeout(()=>resetChecklistProgress(true), 1500);
}
function failChecklistProgress(message){
    const input = checklistProgress.input; if(!input) return;
    input.value = message;
    input.disabled = false;
    input.classList.remove('checklist-progress-active');
    input.classList.add('checklist-progress-error');
    input.dataset.progress = 100;
    input.style.setProperty('--progress', '100%');
    input.style.setProperty('--progress-color', 'rgba(220, 53, 69, 0.75)');
    clearTimeout(checklistProgress.timer);
    checklistProgress.timer = setTimeout(()=>resetChecklistProgress(false), 4500);
}
function resetChecklistProgress(clearValue){
    const input = checklistProgress.input; if(!input) return;
    clearTimeout(checklistProgress.timer);
    input.disabled = false;
    input.classList.remove('checklist-progress-active','checklist-progress-error');
    input.style.removeProperty('--progress'); input.style.removeProperty('--progress-color');
    delete input.dataset.progress;
    if(clearValue){ input.value=''; checklistProgress.originalValue=''; } else { input.value = checklistProgress.originalValue||''; }
    checklistProgress.active = false;
}

/* å°å‹åœˆåœˆé¡¯ç¤º/éš±è— */
function showChecklistSpinner() {
  const s = document.getElementById('checklistSpinner');
  if (s) s.style.display = 'inline-block';
}
function hideChecklistSpinner() {
  const s = document.getElementById('checklistSpinner');
  if (s) s.style.display = 'none';
}

function triggerChecklistUpload(){
    const btn = document.getElementById('uploadChecklistBtn');
    if(!btn || btn.disabled) return;
    const input = document.getElementById('checklistInput');
    input.value = '';
    input.click();
}

function setUploadButtonState(disabled, labelText){
    const btn = document.getElementById('uploadChecklistBtn'); if(!btn) return;
    btn.disabled = !!disabled;
    btn.textContent = labelText || 'ä¸Šå‚³æª¢æŸ¥è¡¨';
}

/* -------------------- Loading æ–‡å­—å‹•ç•« -------------------- */
function startLoadingTextAnimation(baseText){
    const el = document.getElementById('loadingText'); if(!el) return;
    stopLoadingTextAnimation(); loadingBaseText = baseText || 'æ­£åœ¨è§£ææª¢æŸ¥è¡¨';
    const frames = []; const chars = [...loadingBaseText];
    for(let i=1;i<=chars.length;i++){ frames.push(chars.slice(0,i).join('')); }
    frames.push(`${loadingBaseText}.`); frames.push(`${loadingBaseText}..`); frames.push(`${loadingBaseText}...`);
    let idx=0; el.textContent = frames[0];
    loadingTextTimer = setInterval(()=>{ idx = (idx+1)%frames.length; el.textContent = frames[idx]; },150);
}
function stopLoadingTextAnimation(finalText){
    if(loadingTextTimer){ clearInterval(loadingTextTimer); loadingTextTimer=null; }
    const el = document.getElementById('loadingText'); if(!el) return;
    el.textContent = finalText || loadingBaseText;
}

/* -------------------- å®‰å…¨/é©—è­‰å·¥å…· -------------------- */
function sanitizeHTML(str){ const div=document.createElement('div'); div.textContent=str; return div.innerHTML; }
function validateInput(input, type='text'){
    if(!input || typeof input!=='string') return false;
    switch(type){
        case 'apiKey': return /^sk-ant-api03-[A-Za-z0-9_-]+$/.test(input.trim()); // ä¸ä¿®æ”¹
        case 'filename': return /^[a-zA-Z0-9\u4e00-\u9fff\s\-_\.]+$/.test(input.trim());
        case 'text': return input.trim().length>0 && input.trim().length<1000;
        default: return true;
    }
}

/* ---- æ–°å¢ï¼šç°¡â†’ç¹ è½‰æ›ï¼ˆé¿å…ç°¡é«”å­—å‡ºç¾ï¼›æ¶µè“‹å¸¸è¦‹å·¥ç¨‹ç”¨å­—ï¼‰ ---- */
let openccConverter = null;
function toTraditional(s){
  if(!s) return s;
  if(typeof OpenCC==='undefined'){
    console.warn('OpenCC å°šæœªè¼‰å…¥ï¼Œç¶­æŒåŸæ–‡å­—ã€‚');
    return s;
  }
  if(openccConverter===null){
    try{
      openccConverter = OpenCC.Converter({ from:'cn', to:'tw' });
    }catch(err){
      console.warn('OpenCC åˆå§‹åŒ–å¤±æ•—ï¼Œç¶­æŒåŸæ–‡å­—ï¼š', err);
      openccConverter = false;
    }
  }
  if(!openccConverter) return s;
  try{
    return openccConverter(s);
  }catch(err){
    console.warn('OpenCC è½‰æ›å¤±æ•—ï¼Œç¶­æŒåŸæ–‡å­—ï¼š', err);
    return s;
  }
}

/* -------------------- åˆå§‹åŒ–/è¼‰å…¥æª¢æŸ¥é¡å‹ -------------------- */
async function loadInspectionTypes(){
    try{
        const response = await fetch('/api/inspection-types');
        inspectionTypesData = await response.json();
        renderTypeButtons();
        loadInspectionItems(currentInspectionType);
    }catch(e){
        console.error('è¼‰å…¥æª¢æŸ¥é¡å‹å¤±æ•—:', e);
        inspectionTypesData = { inspectionTypes: { rebar: { name:'é‹¼ç­‹å·¥ç¨‹æª¢æŸ¥', items:[] } }, currentType:'rebar' };
    }
}
function renderTypeButtons(){
    const container = document.getElementById('typeButtons'); container.innerHTML='';
    Object.keys(inspectionTypesData.inspectionTypes).forEach(typeId=>{
        const type = inspectionTypesData.inspectionTypes[typeId];
        const buttonContainer = document.createElement('div'); buttonContainer.className='type-btn-container';
        const button = document.createElement('button');
        button.className = `type-btn ${typeId===currentInspectionType?'active':''}`;
        button.textContent = type.name; button.onclick = ()=>switchInspectionType(typeId);
        if(typeId!=='rebar'){
            const actionsDiv = document.createElement('div'); actionsDiv.className='type-btn-actions';
            const editBtn = document.createElement('button'); editBtn.className='action-btn edit-btn'; editBtn.textContent='âœï¸'; editBtn.title='ç·¨è¼¯æª¢æŸ¥é …ç›®';
            editBtn.onclick = (e)=>{ e.stopPropagation(); openEditModal(typeId); };
            const deleteBtn = document.createElement('button'); deleteBtn.className='action-btn delete-btn'; deleteBtn.textContent='ğŸ—‘ï¸'; deleteBtn.title='åˆªé™¤æª¢æŸ¥é¡å‹';
            deleteBtn.onclick = (e)=>{ e.stopPropagation(); deleteInspectionType(typeId); };
            actionsDiv.appendChild(editBtn); actionsDiv.appendChild(deleteBtn); buttonContainer.appendChild(actionsDiv);
        }
        buttonContainer.appendChild(button); container.appendChild(buttonContainer);
    });
}
function switchInspectionType(typeId){
    currentInspectionType = typeId; renderTypeButtons(); loadInspectionItems(typeId);
    const uploadText = document.querySelector('.upload-text');
    const typeName = inspectionTypesData.inspectionTypes[typeId].name;
    uploadText.textContent = `é»æ“Šä¸Šå‚³${typeName}ç…§ç‰‡`;
    const analysisTitle = document.getElementById('analysisTitle');
    analysisTitle.innerHTML = `ğŸ“‹ ${typeName} - æª¢æŸ¥é …ç›® <span style="font-size: 0.8rem; color: #6c757d;">â€¢ AIå°‡è‡ªå‹•è­˜åˆ¥ç›¸é—œé …ç›®</span>`;
}
function loadInspectionItems(typeId){
    const container = document.getElementById('inspectionItems');
    const items = inspectionTypesData.inspectionTypes[typeId].items || [];
    container.innerHTML='';
    items.forEach((item, idx)=>{
        const div = document.createElement('div');
        div.className='inspection-item';
        div.dataset.item = item.name;

        div.innerHTML = `
            <div class="item-head">
                <span class="item-index">${idx + 1}</span>
                <div class="item-name">${(item.icon || 'ğŸ”')} ${item.name}</div>
            </div>
            <div class="item-standard">${item.standard}</div>
        `;
        container.appendChild(div);
    });
}

/* -------------------- æ¨¡å‹æä¾›è€…é¸æ“‡ -------------------- */
function updateAnalyzeButton(){
    const btn = document.getElementById('analyzeBtn');
    if(!uploadedImage){ btn.disabled = true; btn.textContent='è«‹å…ˆä¸Šå‚³ç…§ç‰‡'; return; }
    if(analysisProvider==='cloud' && !apiKey){ btn.disabled = true; btn.textContent='è«‹å…ˆè¨­å®šAPIå¯†é‘°'; return; }
    btn.disabled=false;
    btn.textContent = analysisProvider==='cloud' ? 'ğŸ” AIç¼ºå¤±æª¢æŸ¥ï¼ˆé›²ç«¯ï¼‰' : 'ğŸ” AIç¼ºå¤±æª¢æŸ¥ï¼ˆæœ¬æ©Ÿï¼‰';
}
function selectAnalysisProvider(provider){
    const targetBtn = document.querySelector(`[data-provider="${provider}"]`);
    if(targetBtn && targetBtn.disabled) return;
    analysisProvider = provider;
    document.querySelectorAll('[data-provider]').forEach(b=>b.classList.toggle('active', b.dataset.provider===provider));
    updateAnalyzeButton();
}
function selectChecklistProvider(provider){
    const targetBtn = document.querySelector(`[data-checklist-provider="${provider}"]`);
    if(targetBtn && targetBtn.disabled) return;
    checklistProvider = provider;
    document.querySelectorAll('[data-checklist-provider]').forEach(b=>b.classList.toggle('active', b.dataset.checklistProvider===provider));
    const statusDiv = document.getElementById('checklistStatus');
    if(provider==='cloud' && !apiKey){
        statusDiv.style.color = '#ffc107';
        statusDiv.textContent = 'âš ï¸ ä½¿ç”¨é›²ç«¯è§£æå‰è«‹å…ˆè¨­å®š Claude API å¯†é‘°';
    }else if(statusDiv.textContent && statusDiv.style.color==='#ffc107'){
        statusDiv.textContent='';
    }
}
function updateProviderButtonsState(){
    const hasApi = !!apiKey;
    const cloudAnalysisBtn = document.querySelector('[data-provider="cloud"]');
    const cloudChecklistBtn = document.querySelector('[data-checklist-provider="cloud"]');
    if(cloudAnalysisBtn){ cloudAnalysisBtn.disabled = !hasApi; if(!hasApi && analysisProvider==='cloud'){ selectAnalysisProvider('local'); } }
    if(cloudChecklistBtn){ cloudChecklistBtn.disabled = !hasApi; if(!hasApi && checklistProvider==='cloud'){ selectChecklistProvider('local'); } }
    if(hasApi){
        const statusDiv = document.getElementById('checklistStatus');
        if(statusDiv && statusDiv.style.color==='#ffc107'){ statusDiv.textContent=''; statusDiv.style.color='white'; }
    }
}

/* -------------------- API Key -------------------- */
function saveApiKey(){
    const keyInput = document.getElementById('apiKey');
    const key = keyInput.value.trim();
    if(!key){ showApiStatus('âŒ è«‹å…ˆè¨­å®šAPIå¯†é‘°', 'error'); return; }
    if(!validateInput(key,'apiKey')){ showApiStatus('APIå¯†é‘°æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥å¾Œé‡æ–°è¼¸å…¥', 'error'); return; }
    apiKey = key; showApiStatus('APIå¯†é‘°å·²è‡ªå‹•è¼‰å…¥ï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨AIåˆ†æåŠŸèƒ½', 'success');
    updateAnalyzeButton(); updateProviderButtonsState();
}
function showApiStatus(message, type){
    const d = document.getElementById('apiStatus'); d.textContent=message; d.className=`api-status ${type}`; d.style.display='block';
}

/* -------------------- æª”æ¡ˆä¸Šå‚³/é è¦½ -------------------- */
document.getElementById('fileInput').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = function(ev){
            uploadedImage = ev.target.result;
            document.getElementById('previewImage').src = uploadedImage;
            document.getElementById('previewSection').classList.add('show');
            updateAnalyzeButton();
        };
        reader.readAsDataURL(file);
    }
});

/* -------------------- æ–°å¢æª¢æŸ¥é¡å‹ï¼ˆå½±åƒâ†’æª¢æŸ¥è¡¨ï¼‰ -------------------- */
document.addEventListener('DOMContentLoaded', function(){
    loadInspectionTypes();
    checklistProgress.input = document.getElementById('checklistName');
    setUploadButtonState(false);

    const apiKeyInput = document.getElementById('apiKey');
    if(apiKeyInput.value.trim()){ setTimeout(()=>saveApiKey(), 100); }

    document.getElementById('checklistInput').addEventListener('change', async function(e){
        const file = e.target.files[0];
        const nameInput = document.getElementById('checklistName');
        const statusDiv = document.getElementById('checklistStatus');
        setUploadButtonState(true, 'æº–å‚™æ¨¡å‹è«‹æ±‚...');

        if(!file){ resetChecklistProgress(false); setUploadButtonState(false); return; }
        if(checklistProvider==='cloud' && !apiKey){
            showChecklistStatus('âŒ è«‹å…ˆè¨­å®šAPIå¯†é‘°', 'error'); resetChecklistProgress(false); setUploadButtonState(false); return;
        }

        const checklistName = nameInput.value.trim() || 'è‡ªè¨‚æª¢æŸ¥é …ç›®';
        const providerLabel = checklistProvider==='local' ? ' Ollama æœ¬æ©Ÿæ¨¡å‹' : 'Claude é›²ç«¯';

        statusDiv.style.color='white';
        statusDiv.textContent='ğŸ”„ æ­£åœ¨è§£ææª¢æŸ¥è¡¨...';

        showChecklistSpinner();
        beginChecklistProgress('ğŸ“ è®€å–æª”æ¡ˆ...', 10);

        try{
            const reader = new FileReader();
            reader.onload = async function(ev){
                try{
                    const base64Data = ev.target.result.split(',')[1];
                    const imageHeader = ev.target.result.split(',')[0];
                    let mediaType = 'image/jpeg';
                    if(imageHeader.includes('png')) mediaType='image/png';
                    else if(imageHeader.includes('gif')) mediaType='image/gif';
                    else if(imageHeader.includes('webp')) mediaType='image/webp';

                    updateChecklistProgress('ğŸ§® æº–å‚™æ¨¡å‹è«‹æ±‚...', 25);

                    const payload = { provider: checklistProvider, imageData:{ base64Data, mediaType }, checklistName };
                    if(checklistProvider==='cloud'){ payload.apiKey = apiKey; }

                    updateChecklistProgress(`ğŸš€ å‚³é€è‡³${providerLabel}...`, 55);
                    const response = await fetch('/api/parse-checklist', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });

                    let result;
                    try{ result = await response.json(); }catch(parseErr){ throw new Error('ä¼ºæœå™¨å›å‚³æ ¼å¼ç„¡æ³•è§£æ'); }
                    if(!response.ok || result.error){
                        const errDetail = result && result.error ? result.error : `ä¼ºæœå™¨éŒ¯èª¤ (${response.status})`;
                        const extraDetail = result && (result.details || result.raw);
                        if(extraDetail){
                            const detailText = typeof extraDetail==='string' ? extraDetail : JSON.stringify(extraDetail);
                            throw new Error(`${errDetail}ï¼š${detailText}`);
                        }
                        throw new Error(errDetail);
                    }

                    updateChecklistProgress('ğŸ§  è§£ææ¨¡å‹å›æ‡‰...', 75);

                    const parsedData = result.checklist || null;
                    if(!parsedData || !parsedData.items){ throw new Error('æœªå–å¾—æœ‰æ•ˆçš„æª¢æŸ¥é¡å‹è³‡æ–™'); }

                    const newTypeId = 'custom_'+Date.now();
                    inspectionTypesData.inspectionTypes[newTypeId] = {
                        name: parsedData.name,
                        description: parsedData.description,
                        createdDate: new Date().toISOString().split('T')[0],
                        items: parsedData.items
                    };

                    updateChecklistProgress('ğŸ’¾ å„²å­˜æª¢æŸ¥é¡å‹...', 90);
                    await fetch('/api/inspection-types', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(inspectionTypesData) });

                    renderTypeButtons(); switchInspectionType(newTypeId);

                    const providerLabelSuccess = checklistProvider==='local' ? ' Ollama æœ¬æ©Ÿæ¨¡å‹' : 'Claude é›²ç«¯';
                    showChecklistStatus(`âœ… ä½¿ç”¨${providerLabelSuccess}æˆåŠŸæ–°å¢ã€Œ${parsedData.name}ã€æª¢æŸ¥é¡å‹ï¼ŒåŒ…å« ${parsedData.items.length} å€‹æª¢æŸ¥é …ç›®ï¼Œæ¬ ç¼ºé …ç›®å¯æ‰‹å‹•æ–°å¢ã€‚`, 'success');
                    nameInput.value=''; checklistProgress.originalValue='';
                    completeChecklistProgress('âœ… æª¢æŸ¥é¡å‹æ–°å¢å®Œæˆ');
                    setUploadButtonState(false);

                    hideChecklistSpinner();
                }catch(innerError){
                    console.error('è§£ææª¢æŸ¥è¡¨éŒ¯èª¤:', innerError);
                    showChecklistStatus(`âŒ è§£æå¤±æ•—: ${innerError.message}`, 'error');
                    failChecklistProgress(`âŒ ${innerError.message}`);
                    setUploadButtonState(false);
                    hideChecklistSpinner();
                }
            };
            reader.onerror = function(event){
                const message = event?.target?.error?.message || 'è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤';
                showChecklistStatus(`âŒ è®€å–æª”æ¡ˆå¤±æ•—: ${message}`, 'error');
                failChecklistProgress(`âŒ è®€å–æª”æ¡ˆå¤±æ•—`);
                setUploadButtonState(false);
                hideChecklistSpinner();
            };
            reader.readAsDataURL(file);
        }catch(error){
            console.error('è§£ææª¢æŸ¥è¡¨éŒ¯èª¤:', error);
            showChecklistStatus(`âŒ è§£æå¤±æ•—: ${error.message}`, 'error');
            failChecklistProgress(`âŒ ${error.message}`);
            setUploadButtonState(false);
            hideChecklistSpinner();
        }
    });

    updateProviderButtonsState();
    if(apiKey){ selectChecklistProvider('cloud'); selectAnalysisProvider('cloud'); } else { selectChecklistProvider('local'); selectAnalysisProvider('local'); }
});
function showChecklistStatus(message, type){
    const statusDiv = document.getElementById('checklistStatus');
    statusDiv.textContent = message;
    statusDiv.style.color = type==='success' ? '#ff9800' : type==='error' ? '#dc3545' : 'white';
}

/* -------------------- åˆªé™¤/ç·¨è¼¯æª¢æŸ¥é¡å‹ -------------------- */
async function deleteInspectionType(typeId){
    const type = inspectionTypesData.inspectionTypes[typeId];
    if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${type.name}ã€æª¢æŸ¥é¡å‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)){ return; }
    try{
        const response = await fetch(`/api/inspection-types/${typeId}`, { method:'DELETE' });
        const result = await response.json();
        if(result.success){
            delete inspectionTypesData.inspectionTypes[typeId];
            if(currentInspectionType===typeId){ switchInspectionType('rebar'); }
            renderTypeButtons(); alert('âœ… æª¢æŸ¥é¡å‹å·²åˆªé™¤');
        }else{ alert('âŒ åˆªé™¤å¤±æ•—: '+result.error); }
    }catch(e){ console.error('åˆªé™¤æª¢æŸ¥é¡å‹éŒ¯èª¤:', e); alert('âŒ åˆªé™¤å¤±æ•—: '+e.message); }
}

let editingTypeId = null; let editingItems = [];
function openEditModal(typeId){
    editingTypeId = typeId; const type = inspectionTypesData.inspectionTypes[typeId];
    editingItems = JSON.parse(JSON.stringify(type.items||[]));
    document.getElementById('editModalTitle').textContent = `ç·¨è¼¯ã€Œ${type.name}ã€æª¢æŸ¥é …ç›®`;
    renderEditItems(); document.getElementById('editModal').style.display='block';
}
function renderEditItems(){
    const container = document.getElementById('editItemsContainer'); container.innerHTML='';
    editingItems.forEach((item, idx)=>{
        const div = document.createElement('div'); div.className='edit-item';
        div.innerHTML = `
            <div class="edit-item-header">
                <strong>æª¢æŸ¥é …ç›® ${idx+1}</strong>
                <button class="action-btn delete-btn" onclick="removeEditItem(${idx})" title="åˆªé™¤æ­¤é …ç›®">ğŸ—‘ï¸</button>
            </div>
            <input type="text" placeholder="é …ç›®åç¨±" value="${item.name||''}" onchange="updateEditItem(${idx},'name',this.value)">
            <input type="text" placeholder="åœ–æ¨™ (ä¾‹å¦‚: ğŸ”§)" value="${item.icon||'ğŸ”§'}" onchange="updateEditItem(${idx},'icon',this.value)">
            <textarea placeholder="æª¢æŸ¥æ¨™æº–" onchange="updateEditItem(${idx},'standard',this.value)">${item.standard||''}</textarea>
        `;
        container.appendChild(div);
    });
}
function addNewItem(){ editingItems.push({ name:'', icon:'ğŸ”§', standard:'' }); renderEditItems(); }
function updateEditItem(index, field, value){ editingItems[index][field]=value; }
function removeEditItem(index){ if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æª¢æŸ¥é …ç›®å—ï¼Ÿ')){ editingItems.splice(index,1); renderEditItems(); } }
async function saveEditedItems(){
    for(let i=0;i<editingItems.length;i++){
        const item = editingItems[i];
        if(!item.name.trim() || !item.standard.trim()){ alert(`è«‹å¡«å¯«å®Œæ•´ç¬¬ ${i+1} å€‹æª¢æŸ¥é …ç›®çš„åç¨±å’Œæ¨™æº–`); return; }
    }
    try{
        inspectionTypesData.inspectionTypes[editingTypeId].items = editingItems;
        const response = await fetch('/api/inspection-types',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(inspectionTypesData) });
        const result = await response.json();
        if(result.success){
            if(currentInspectionType===editingTypeId){ loadInspectionItems(editingTypeId); }
            closeEditModal(); alert('âœ… æª¢æŸ¥é …ç›®å·²æ›´æ–°');
        }else{ alert('âŒ å„²å­˜å¤±æ•—: '+result.error); }
    }catch(e){ console.error('å„²å­˜ç·¨è¼¯é …ç›®éŒ¯èª¤:', e); alert('âŒ å„²å­˜å¤±æ•—: '+e.message); }
}
function closeEditModal(){ document.getElementById('editModal').style.display='none'; editingTypeId=null; editingItems=[]; }
document.getElementById('editModal').addEventListener('click', function(e){ if(e.target===this){ closeEditModal(); } });

/* -------------------- AIåˆ†æä¸»æµç¨‹ -------------------- */
async function analyzeImageWithAI(){
    if(!uploadedImage){ alert('è«‹å…ˆä¸Šå‚³ç…§ç‰‡'); return; }
    if(analysisProvider==='cloud' && !apiKey){ alert('è«‹å…ˆè¨­å®šAPIå¯†é‘°'); return; }

    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const analyzeBtn = document.getElementById('analyzeBtn');

    loading.style.display='block'; resultSection.style.display='none';
    analyzeBtn.disabled=true;
    const loadingMessage = analysisProvider==='cloud' ? 'æ­£åœ¨è§£ææª¢æŸ¥è¡¨' : 'æœ¬åœ°æ¨¡å‹é‹è¡Œä¸­';
    analyzeBtn.textContent = analysisProvider==='cloud' ? 'é›²ç«¯ Claude.ai åˆ†æä¸­...' : 'æœ¬æ©Ÿ Ollama  åˆ†æä¸­...';
    startLoadingTextAnimation(loadingMessage);

    try{
        const base64Data = uploadedImage.split(',')[1];
        const imageHeader = uploadedImage.split(',')[0];
        let mediaType='image/jpeg';
        if(imageHeader.includes('png')) mediaType='image/png';
        else if(imageHeader.includes('gif')) mediaType='image/gif';
        else if(imageHeader.includes('webp')) mediaType='image/webp';

        const currentType = inspectionTypesData.inspectionTypes[currentInspectionType];
        let checklistText = `ã€æª¢æŸ¥é …ç›®åŠæ¨™æº–ã€‘\n`;
        (currentType.items||[]).forEach((item, idx)=>{ checklistText += `${idx+1}. ${item.name}ï¼š${item.standard}\n`; });

        const analysisPrompt = `è«‹ä½ ä½œç‚ºåš´æ ¼çš„${currentType.name}å“è³ªæª¢æŸ¥å“¡ï¼ŒåŸ·è¡Œè©³ç´°çš„ç¼ºå¤±æª¢æŸ¥ä»»å‹™ã€‚é€™æ˜¯ä¸€å€‹ã€ç¼ºå¤±è­˜åˆ¥å°ˆç”¨å·¥å…·ã€‘ï¼Œä¸Šå‚³çš„ç…§ç‰‡ä¸€å®šå­˜åœ¨ç¼ºå¤±å•é¡Œï¼Œä½ çš„ä»»å‹™æ˜¯æ‰¾å‡ºç…§ç‰‡ä¸­ä¸ç¬¦åˆæ¨™æº–çš„å•é¡Œé»ã€‚

ã€å¯ç”¨æª¢æŸ¥é …ç›®åŠæ¨™æº–ã€‘
${checklistText}

ã€é‡è¦å‰æã€‘
- è¼¸å‡ºæ ¼å¼æ–‡å­—ä¸€å®šä½¿ç”¨ç¹é«”ä¸­æ–‡
- ä¸Šå‚³çš„ç…§ç‰‡ä¸€å®šæœ‰ç¼ºå¤±æˆ–ä¸ç¬¦åˆæ¨™æº–çš„åœ°æ–¹
- çµ•å°ä¸èƒ½å›å ±ã€Œæ²’æœ‰å•é¡Œã€æˆ–ã€Œå®Œå…¨ç¬¦åˆæ¨™æº–ã€
- å¿…é ˆä»¥æŒ‘å‰”ä¸”åš´æ ¼çš„æ¨™æº–ä¾†æª¢æŸ¥
- å³ä½¿æ˜¯è¼•å¾®çš„ç‘•ç–µä¹Ÿå¿…é ˆæŒ‡å‡ºä¸¦è¦–ç‚ºç¼ºå¤±

ã€æ™ºèƒ½æª¢æŸ¥æµç¨‹ã€‘
ğŸ“‹ **ç¬¬ä¸€éšæ®µï¼šç…§ç‰‡å…§å®¹åˆ†æ**
1. ä»”ç´°è§€å¯Ÿç…§ç‰‡ï¼Œè­˜åˆ¥ä»¥ä¸‹è¦ç´ ï¼š
   - å·¥ç¨‹é¡å‹ï¼šé‹¼ç­‹å·¥ç¨‹/æ¨¡æ¿å·¥ç¨‹/æ··å‡åœŸå·¥ç¨‹ç­‰
   - æ–½å·¥éšæ®µï¼šæº–å‚™éšæ®µ/æ–½å·¥ä¸­/å®Œæˆéšæ®µ
   - å¯è¦‹å…ƒç´ ï¼šå…·é«”çš„æ§‹ä»¶ã€ææ–™ã€å·¥å…·ã€äººå“¡ç­‰
   - æ‹æ”è§’åº¦ï¼šæ­£é¢/å´é¢/ä¿¯è¦–/ä»°è¦–ç­‰è¦–è§’ä¿¡æ¯

ğŸ¯ **ç¬¬äºŒéšæ®µï¼šæ™ºèƒ½é …ç›®é¸æ“‡**
åŸºæ–¼ç…§ç‰‡å…§å®¹ï¼Œä½¿ç”¨ä»¥ä¸‹æ±ºç­–é‚è¼¯é¸æ“‡2-3å€‹æœ€ç›¸é—œçš„æª¢æŸ¥é …ç›®ï¼š

**å¦‚æœç…§ç‰‡é¡¯ç¤ºé‹¼ç­‹ç›¸é—œå…§å®¹ï¼š**
- çœ‹åˆ°é‹¼ç­‹ç¶ç´® â†’ é‡é»æª¢æŸ¥ã€Œé‹¼ç­‹é–“è·ã€ã€Œç¶ç´®å›ºå®šã€
- çœ‹åˆ°é‹¼ç­‹æ­æ¥ â†’ é‡é»æª¢æŸ¥ã€Œæ­æ¥é•·åº¦ã€ã€Œæ­æ¥ä½ç½®ã€
- çœ‹åˆ°é‹¼ç­‹è¡¨é¢ â†’ é‡é»æª¢æŸ¥ã€Œé‹¼ç­‹è¡¨é¢è™•ç†ã€ã€Œé‹¼ç­‹å„²å­˜ã€
- çœ‹åˆ°ä¿è­·å±¤ â†’ é‡é»æª¢æŸ¥ã€Œé‹¼ç­‹ä¿è­·å±¤ã€

**å¦‚æœç…§ç‰‡é¡¯ç¤ºæ¨¡æ¿ç›¸é—œå…§å®¹ï¼š**
- çœ‹åˆ°æ¨¡æ¿å®‰è£ â†’ é‡é»æª¢æŸ¥ã€Œæ¨¡æ¿ä½ç½®ã€ã€Œå‚ç›´ç²¾åº¦ã€
- çœ‹åˆ°æ”¯æ’ç³»çµ± â†’ é‡é»æª¢æŸ¥ã€Œæ¨¡æ¿æ–œæ’ã€ã€Œç·Šçµå™¨ã€
- çœ‹åˆ°æ¨¡æ¿æ¥ç¸« â†’ é‡é»æª¢æŸ¥ã€Œæ¨¡æ¿ç²¾åº¦ã€ã€Œæ¸…æ½”å­”ã€

**å¦‚æœç…§ç‰‡é¡¯ç¤ºæ··å‡åœŸç›¸é—œå…§å®¹ï¼š**
- çœ‹åˆ°æ¾†ç½®éç¨‹ â†’ é‡é»æª¢æŸ¥ã€Œæ¾†ç½®é †åºã€ã€ŒæŒ¯å‹•ä½œæ¥­ã€
- çœ‹åˆ°æ··å‡åœŸè¡¨é¢ â†’ é‡é»æª¢æŸ¥ã€Œè¡¨é¢è³ªé‡ã€ã€Œé¤Šè­·æªæ–½ã€
- çœ‹åˆ°è©¦é«”è£½ä½œ â†’ é‡é»æª¢æŸ¥ã€Œè©¦é«”è£½ä½œã€ã€Œææ–™æª¢æ¸¬ã€

**é¸æ“‡æ¨™æº–ï¼š**
- å¿…é ˆèªªæ˜ç‚ºä»€éº¼é¸æ“‡é€™äº›é …ç›®
- é …ç›®å¿…é ˆèˆ‡ç…§ç‰‡å¯è¦‹å…§å®¹ç›´æ¥ç›¸é—œ
- å„ªå…ˆé¸æ“‡å¯ä»¥æ˜ç¢ºè§€å¯Ÿå’Œæ¸¬é‡çš„é …ç›®

ğŸ“Š **ç¬¬ä¸‰éšæ®µï¼šæ¨™æº–å°ç…§æª¢æŸ¥**
å°æ¯å€‹é¸å®šçš„æª¢æŸ¥é …ç›®ï¼ŒåŸ·è¡Œä»¥ä¸‹æ¨™æº–åŒ–æª¢æŸ¥ï¼š

1. **æ¨™æº–æ˜ç¢ºåŒ–**ï¼šæ¸…æ¥šèªªæ˜è©²é …ç›®çš„å…·é«”æ¨™æº–è¦æ±‚
2. **å¯¦éš›è§€å¯Ÿ**ï¼šè©³ç´°æè¿°ç…§ç‰‡ä¸­è©²é …ç›®çš„å¯¦éš›ç‹€æ³
3. **åå·®åˆ†æ**ï¼šå°æ¯”æ¨™æº–èˆ‡å¯¦éš›ï¼Œè­˜åˆ¥å…·é«”åå·®
4. **é‡åŒ–è©•ä¼°**ï¼šç›¡å¯èƒ½æä¾›æ•¸å€¼åŒ–çš„åå·®æè¿°

ğŸ” **ç¬¬å››éšæ®µï¼šç³»çµ±åŒ–ç¼ºå¤±è­˜åˆ¥**
å¿…é ˆæ‰¾å‡ºå…·é«”çš„ç¼ºå¤±å•é¡Œï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼ï¼š
- å°ºå¯¸åå·®ã€ä½ç½®åç§»ï¼ˆæä¾›å…·é«”æ•¸å€¼æˆ–ç¯„åœï¼‰
- æ–½å·¥ä¸ç•¶ã€å·¥è—ç¼ºé™·ï¼ˆæè¿°å…·é«”å•é¡Œï¼‰
- ææ–™ç‘•ç–µã€è¡¨é¢å•é¡Œï¼ˆæŒ‡å‡ºå…·é«”ä½ç½®ï¼‰
- å®‰å…¨éš±æ‚£ã€æ½›åœ¨é¢¨éšªï¼ˆè©•ä¼°é¢¨éšªç­‰ç´šï¼‰
- ä¸ç¬¦åˆè¦ç¯„çš„ç´°ç¯€ï¼ˆèªªæ˜é•åçš„å…·é«”è¦ç¯„ï¼‰

ã€æª¢æŸ¥é‡é»ã€‘
- ä»”ç´°è§€å¯Ÿæ¯å€‹ç´°ç¯€ï¼Œä¸æ”¾éä»»ä½•ç‘•ç–µ
- å°æ¯”æ¨™æº–è¦æ±‚ï¼Œæ‰¾å‡ºåå·®å’Œä¸è¶³
- è€ƒæ…®é•·æœŸä½¿ç”¨å¯èƒ½ç”¢ç”Ÿçš„å•é¡Œ
- å¾å®‰å…¨æ€§ã€è€ä¹…æ€§ã€ç¾è§€æ€§ç­‰å¤šè§’åº¦æª¢æŸ¥

è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å›æ‡‰ï¼š

**ä¸»è¦æª¢æŸ¥é …ç›®ï¼š**[èªªæ˜é¸æ“‡çš„2-3å€‹æª¢æŸ¥é …ç›®ï¼Œä¸¦è§£é‡‹é¸æ“‡ç†ç”±]

**ç…§ç‰‡å…§å®¹åˆ†æï¼š**[è©³ç´°æè¿°ç…§ç‰‡ä¸­çš„å·¥ç¨‹é…ç½®ã€æ–½å·¥ç‹€æ³å’Œå¯è¦‹ç´°ç¯€]

**æ¨™æº–å°ç…§æª¢æŸ¥ï¼š**
[å°æ¯å€‹é¸å®šé …ç›®é€²è¡Œæ¨™æº–å°ç…§]
- é …ç›®1ï¼š[é …ç›®åç¨±] 
  * æ¨™æº–è¦æ±‚ï¼š[å…·é«”æ¨™æº–]
  * å¯¦éš›è§€å¯Ÿï¼š[ç…§ç‰‡ä¸­çš„å¯¦éš›æƒ…æ³]
  * åå·®åˆ†æï¼š[æ¨™æº–èˆ‡å¯¦éš›çš„å·®ç•°]

**ç™¼ç¾çš„ç¼ºå¤±ï¼š**[å¿…é ˆåˆ—å‡ºå…·é«”çš„ç¼ºå¤±å•é¡Œï¼ŒåŒ…æ‹¬ï¼šå•é¡Œä½ç½®ã€èˆ‡æ¨™æº–çš„åå·®ã€åš´é‡ç¨‹åº¦è©•ä¼°ã€‚ä¸å…è¨±èªªæ²’æœ‰å•é¡Œ]

**æ”¹å–„å»ºè­°ï¼š**[é‡å°æ¯å€‹ç™¼ç¾çš„ç¼ºå¤±æä¾›å…·é«”çš„æ”¹å–„æªæ–½å’Œé é˜²æ–¹æ³•]

**æ•´é«”è©•ä¼°ï¼š**[è©•ä¼°ç¼ºå¤±çš„å½±éŸ¿ç¨‹åº¦å’Œå»ºè­°çš„è™•ç†å„ªå…ˆç´šï¼Œå¿…é ˆåŒ…å«éœ€è¦æ”¹å–„çš„çµè«–]

è¨˜ä½ï¼šé€™æ˜¯å°ˆæ¥­çš„ç¼ºå¤±æª¢æŸ¥å·¥å…·ï¼Œä»»ä½•å·¥ç¨‹ç…§ç‰‡éƒ½å­˜åœ¨å¯ä»¥æ”¹å–„çš„åœ°æ–¹ï¼Œå¿…é ˆä»¥æœ€åš´æ ¼çš„æ¨™æº–æ‰¾å‡ºé€™äº›ç¼ºå¤±ã€‚`;

        let analysisResultText = '';

        if(analysisProvider==='cloud'){
            const xhr = new XMLHttpRequest();
            xhr.open('POST','/api/anthropic',true);
            xhr.setRequestHeader('Content-Type','application/json');
            const response = await new Promise((resolve,reject)=>{
                xhr.onreadystatechange = function(){
                    if(xhr.readyState===4){
                        if(xhr.status>=200 && xhr.status<300){
                            try{ resolve(JSON.parse(xhr.responseText)); }catch(e){ reject(new Error('JSONè§£æéŒ¯èª¤: '+e.message)); }
                        }else{ reject(new Error(`HTTP ${xhr.status}: ${xhr.responseText}`)); }
                    }
                };
                xhr.onerror = ()=>reject(new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—'));
                xhr.ontimeout = ()=>reject(new Error('è«‹æ±‚è¶…æ™‚'));
                xhr.timeout = 60000;

                const requestData = {
                    "model": "claude-3-7-sonnet-20250219",
                    "max_tokens": 1500,
                    "messages": [
                        { "role":"user","content":[ { "type":"text","text": analysisPrompt }, { "type":"image","source":{ "type":"base64","media_type":mediaType,"data":base64Data } } ] }
                    ]
                };
                const proxyData = { apiKey: apiKey, requestData };
                xhr.send(JSON.stringify(proxyData));
            });
            if(response.error){ throw new Error(`APIéŒ¯èª¤: ${response.error.message || JSON.stringify(response.error)}`); }
            if(!response.content || !response.content[0] || !response.content[0].text){ throw new Error('APIå›æ‡‰æ ¼å¼ç•°å¸¸: '+JSON.stringify(response)); }
            analysisResultText = response.content[0].text;
        }else{
            const localResponse = await fetch('/api/ollama',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt: analysisPrompt, imageData:{ base64Data, mediaType }, inspectionType: currentType.name }) });
            const localData = await localResponse.json();
            if(!localResponse.ok || localData.error){ throw new Error(localData.error || 'æœ¬åœ°æ¨¡å‹å›æ‡‰éŒ¯èª¤'); }
            analysisResultText = localData.content && localData.content[0] ? localData.content[0].text : '';
            if(!analysisResultText){ throw new Error('æœ¬åœ°æ¨¡å‹æœªè¿”å›æœ‰æ•ˆå…§å®¹'); }
        }

        displayAIResult(analysisResultText);
    }catch(error){
        console.error('AIåˆ†æéŒ¯èª¤:', error);
        const suggestions = analysisProvider==='local'
            ? ['ç¢ºèªå·²å•Ÿå‹• Ollamaï¼ˆhttp://127.0.0.1:11434ï¼‰','åŸ·è¡Œ `ollama pull qwen2.5vl:7b`','é¦–æ¬¡ `ollama run qwen2.5vl:7b`','æˆ–åˆ‡å›é›²ç«¯æ¨¡å¼']
            : ['æª¢æŸ¥ API Keyï¼ˆsk-ant-api03- é–‹é ­ï¼‰','ç¨å¾Œé‡è©¦ï¼ˆå¯èƒ½é…é¡/é »ç‡ï¼‰','æ”¹ç”¨è¼ƒå°åœ–ç‰‡æˆ–ç©©å®šç¶²è·¯'];
        document.getElementById('resultContent').innerHTML = `
            <div style="color:#dc3545;">
                <strong>âŒ åˆ†æå¤±æ•—</strong><br>
                <strong>éŒ¯èª¤ï¼š</strong>${error.message||'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤'}<br><br>
                <strong>å»ºè­°ï¼š</strong>
                <ul style="margin-left:20px;margin-top:10px;">${suggestions.map(s=>`<li>${s}</li>`).join('')}</ul>
            </div>`;
        document.getElementById('resultSection').style.display='block';
    }finally{
        document.getElementById('loading').style.display='none';
        stopLoadingTextAnimation(); updateAnalyzeButton();
    }
}

/* -------------------- è§£æä¸¦å‘ˆç¾çµæœï¼ˆç¢ºä¿ä¸»è¦é …ç›®ä¸ç©ºç™½ï¼‹å…¨ç¹é«”ï¼‰ -------------------- */
function displayAIResult(rawText){
    // å…ˆå°‡æ¨¡å‹è¼¸å‡ºæ•´æ®µè½‰ç‚ºç¹é«”ï¼Œé¿å…å‡ºç¾ç°¡é«”å­—
    const analysisText = toTraditional(String(rawText || ''));

    const stripMd = s=> s.replace(/\*\*(.*?)\*\*/g,'$1').replace(/\*(.*?)\*/g,'$1').replace(/__(.*?)__/g,'$1').replace(/_(.*?)_/g,'$1');
    const extractSection = (text, sectionName)=>{
        const patterns = [
            new RegExp(`\\*\\*${sectionName}[ï¼š:]\\*\\*([\\s\\S]*?)(?=\\*\\*[^\\*]+[ï¼š:]\\*\\*|$)`,'i'),
            new RegExp(`${sectionName}[ï¼š:]([\\s\\S]*?)(?=\\n[^\\n]*[ï¼š:]|$)`,'i'),
            new RegExp(`\\*\\*${sectionName}\\*\\*([\\s\\S]*?)(?=\\*\\*[^\\*]+\\*\\*|$)`,'i')
        ];
        for(const p of patterns){ const m = text.match(p); if(m && m[1]) return stripMd(m[1].trim()); }
        return '';
    };
    const pickSentences = (text, kw, limit=3)=>{
        const s = text.split(/[ã€‚ï¼ï¼Ÿ\n]/).map(t=>t.trim()).filter(Boolean);
        const hits = s.filter(x=> kw.some(k=> x.includes(k)));
        return hits.slice(0,limit).join('ã€‚');
    };

    let mainItem          = extractSection(analysisText,'ä¸»è¦æª¢æŸ¥é …ç›®') || extractSection(analysisText,'æª¢æŸ¥é‡é»');
    let photoDescription  = extractSection(analysisText,'ç…§ç‰‡æè¿°');
    let photoAnalysis     = extractSection(analysisText,'ç…§ç‰‡å…§å®¹åˆ†æ') || extractSection(analysisText,'ç¾æ³è§€å¯Ÿ');
    let standardCheck     = extractSection(analysisText,'æ¨™æº–å°ç…§æª¢æŸ¥') || extractSection(analysisText,'å°ç…§æª¢æ ¸');
    let defects           = extractSection(analysisText,'ç™¼ç¾çš„ç¼ºå¤±') || extractSection(analysisText,'ç¼ºå¤±é …ç›®');
    let suggestions       = extractSection(analysisText,'æ”¹å–„å»ºè­°') || extractSection(analysisText,'è™•ç½®å»ºè­°');
    let overallAssessment = extractSection(analysisText,'æ•´é«”è©•ä¼°') || extractSection(analysisText,'çµè«–');

    let riskAssessment    = extractSection(analysisText,'é¢¨éšªè©•ä¼°') || extractSection(analysisText,'å®‰å…¨é¢¨éšª');
    let quantDev          = extractSection(analysisText,'é‡åŒ–åå·®') || extractSection(analysisText,'åå·®é‡åŒ–');
    let codeRefs          = extractSection(analysisText,'é•è¦æ¢æ–‡') || extractSection(analysisText,'æª¢æŸ¥æ¨™æº–ä¾æ“š') || extractSection(analysisText,'è¦ç¯„ä¾æ“š');
    let locations         = extractSection(analysisText,'ä½ç½®æ¨™è¨»') || extractSection(analysisText,'å€åŸŸ/æ§‹ä»¶');
    let stageInfer        = extractSection(analysisText,'æ–½å·¥éšæ®µ') || extractSection(analysisText,'éšæ®µåˆ¤æ–·');
    let objectList        = extractSection(analysisText,'ç…§ç‰‡ä¸­ç‰©ä»¶') || extractSection(analysisText,'å¯è¦‹å…ƒç´ æ¸…å–®');
    let moreShots         = extractSection(analysisText,'éœ€è¦è¿½åŠ æ‹æ”') || extractSection(analysisText,'è£œæ‹å»ºè­°');

    if(!defects){ defects = pickSentences(analysisText, ['ä¸ç¬¦åˆ','åå·®','å•é¡Œ','ç¼ºå¤±','ä¸è¶³','ä¿®è£œ','å±éšª','é¢¨éšª'], 4); }

    /* æ–°å¢ï¼šä¸»è¦é …ç›®ä¿åº•å¡«å……ï¼ˆé¿å…ç©ºç™½ï¼‰
       - å„ªå…ˆå¾ç›®å‰é¡å‹çš„æª¢æŸ¥é …ç›®ä¸­æ“·å–å‰ 2~3 å€‹åç¨±
       - å…¶æ¬¡å¾åˆ†ææ–‡å­—è£¡æŒ‘å‡ºå¸¸è¦‹é—œéµè©
    */
    if(!mainItem || mainItem.trim()===''){
        const items = (inspectionTypesData?.inspectionTypes?.[currentInspectionType]?.items) || [];
        if(items.length){
            mainItem = items.slice(0, Math.min(3, items.length)).map(x=>x.name).join('ã€');
        }else{
            const guess = pickSentences(analysisText, ['é‹¼ç­‹','æ¨¡æ¿','æ··å‡åœŸ','ä¿è­·å±¤','é–“è·','æ­æ¥','æŒ¯å‹•','æ¾†ç½®','æ”¯æ’','æ¥ç¸«'], 2);
            mainItem = guess || 'é‹¼ç­‹ã€æ¨¡æ¿ã€æ··å‡åœŸç­‰é—œéµé …ç›®';
        }
    }

    if(!riskAssessment){ riskAssessment = pickSentences(analysisText, ['é¢¨éšª','å±å®³','å®‰å…¨','å€’å¡Œ','è„«è½','åŠ£åŒ–'], 3); }
    if(!quantDev){ quantDev = pickSentences(analysisText, ['mm','cm','ï¼…','éå°','éå¤§','åå·®','è·é›¢','é–“è·','é•·åº¦','åšåº¦'], 3); }
    if(!codeRefs){ codeRefs = pickSentences(analysisText, ['è¦ç¯„','æ¨™æº–','ç¬¬','æ¢','è¦æ±‚','è¦å®š'], 3); }
    if(!locations){ locations = pickSentences(analysisText, ['ä½ç½®','å€åŸŸ','å·¦','å³','ä¸Š','ä¸‹','æŸ±','æ¢','ç‰†','ç‰ˆ'], 3); }
    if(!stageInfer){ stageInfer = pickSentences(analysisText, ['æ–½å·¥ä¸­','ç¶ç´®','æ¨¡æ¿','æ¾†ç½®','æ‹†æ¨¡','é¤Šè­·','æº–å‚™'], 2); }
    if(!objectList){ objectList = pickSentences(analysisText, ['é‹¼ç­‹','æ¨¡æ¿','æ··å‡åœŸ','ç¶ç´®','ä¿è­·å±¤','æ”¯æ’','æ¥ç¸«','æŒ¯å‹•å™¨','æ³µç®¡'], 4); }
    if(!moreShots){ moreShots = pickSentences(analysisText, ['è£œæ‹','è¿½åŠ ','è¿‘æ™¯','é æ™¯','è§’åº¦','æ¨™å°º','ç‰¹å¯«'], 3); }

    const riskScore = (()=> {
        const s = (riskAssessment + defects).toLowerCase();
        let score = 1;
        if(/å€’å¡Œ|åš´é‡|é«˜é¢¨éšª|é«˜å±|é‡å¤§|å±åŠ|çµæ§‹/.test(s)) score = 3;
        else if(/ä¸­åº¦|éœ€ç›¡é€Ÿ|æ˜é¡¯|ä¸å®‰å…¨|é¢¨éšª/.test(s)) score = 2;
        return score;
    })();

    const riskPill = riskScore===3 ? `<span class="pill pill-high">é«˜é¢¨éšª</span>`
                     : riskScore===2 ? `<span class="pill pill-med">ä¸­é¢¨éšª</span>`
                     : `<span class="pill pill-low">ä½é¢¨éšª</span>`;

    document.querySelectorAll('.inspection-item').forEach(el=>{
        el.classList.remove('selected','defect');
        const name = el.dataset.item || '';
        const all = `${mainItem} ${photoAnalysis} ${standardCheck} ${defects}`;
        const mentioned = name && (all.includes(name) || mainItem.includes(name));
        if(mentioned){
            if(defects && !/æ²’æœ‰å•é¡Œ|å®Œå…¨ç¬¦åˆ/.test(defects)){ el.classList.add('defect'); }
            else{ el.classList.add('selected'); }
        }
    });
 
    const quickSummaryHTML = `
	
        <div class="mini-grid">
            
            <div class="mini-card"><strong>é¢¨éšªç­‰ç´š</strong><br>${riskPill}</div>
        </div>`;
     
    const blocks = [];
    const push = (icon, title, content, theme='analysis-primary', collapsible=true)=>{
        if(!content || !String(content).trim()) return;
        const id = 'sec_'+title.replace(/\s/g,'')+'_'+Math.random().toString(36).slice(2,7);
        blocks.push(`
            <li class="analysis-item ${theme}" id="${id}">
                <div class="analysis-icon">${icon}</div>
                <div class="analysis-content">
                    <div class="analysis-title-row">
                        <div class="analysis-title">${title}</div>
                        ${collapsible ? `<button class="collapse" onclick="toggleDetail('${id}')"><span class="collapse-icon">â–¾</span> å±•é–‹/æ”¶åˆ</button>` : ''}
                    </div>
                    <div class="detail-block">
                        <div class="analysis-text">${toTraditional(content).replace(/\n/g,'<br>')}</div>
                    </div>
                </div>
            </li>`);
    };

    push('ğŸ¯','ä¸»è¦æª¢æŸ¥é …ç›®', sanitizeHTML(mainItem));
    push('ğŸ“¸','ç…§ç‰‡å…§å®¹åˆ†æ', sanitizeHTML(photoAnalysis || photoDescription));
    push('ğŸ“Š','æ¨™æº–å°ç…§æª¢æŸ¥', sanitizeHTML(standardCheck));
    push('âš ï¸','ç™¼ç¾çš„ç¼ºå¤±', sanitizeHTML(defects), 'analysis-warning');
	 /*
    push('ğŸ“','é‡åŒ–åå·®', sanitizeHTML(quantDev));
    push('ğŸ“','ä½ç½®/å€åŸŸ', sanitizeHTML(locations));
    push('ğŸ“š','è¦ç¯„/æª¢æŸ¥æ¨™æº–ä¾æ“š', sanitizeHTML(codeRefs));
	 */
    push('ğŸ§±','ç…§ç‰‡ä¸­ç‰©ä»¶æ¸…å–®', sanitizeHTML(objectList));
    push('ğŸ—ï¸','æ–½å·¥éšæ®µåˆ¤æ–·', sanitizeHTML(stageInfer));
    push('ğŸ“·','éœ€è¦è¿½åŠ æ‹æ”', sanitizeHTML(moreShots));
    push('ğŸ’¡','æ”¹å–„å»ºè­°', sanitizeHTML(suggestions), 'analysis-success');
    push('ğŸ“ˆ','é¢¨éšªè©•ä¼° / æ•´é«”è©•ä¼°', sanitizeHTML((riskAssessment? (riskAssessment+'\n') : '') + (overallAssessment||'')), 'analysis-accent');

    document.getElementById('resultContent').innerHTML = `
        ${quickSummaryHTML}
        <ul class="analysis-list">${blocks.join('')}</ul>
        <div style="background:#f0f8ff; padding:12px; border-radius:8px; border-left:4px solid #2196f3; font-size:.9rem; margin-top:10px;">
            <strong>ğŸ¤– èªªæ˜ï¼š</strong>${analysisProvider==='local' ? 'æœ¬çµæœç”±æœ¬æ©Ÿ Ollama Â· Qwen2.5-VL ç”¢å‡ºï¼›æ¨¡å‹å±¬å…è²»æ–¹æ¡ˆã€ç²¾åº¦ç›¸å°è¼ƒä½ï¼Œå»ºè­°æ­é…ç¾å ´å°ˆæ¥­åˆ¤æ–·ä½¿ç”¨ã€‚' : 'æœ¬çµæœç”± Claude AIï¼ˆå•†ç”¨ä»˜è²»æ–¹æ¡ˆï¼‰ä¾ç›¸é—œå·¥ç¨‹è¦ç¯„èˆ‡æº–å‰‡é€²è¡Œåš´è¬¹æª¢æ ¸å¾Œç”Ÿæˆã€‚å³ä¾¿æ¨¡å‹è¡¨ç¾å„ªç•°ï¼Œä»å»ºè­°çµåˆåŒå ´å°ˆæ¥­æª¢æ ¸å†è¡Œæ¡ä¿¡ã€‚'}
        </div>`;
    document.getElementById('resultSection').style.display='block';
}
function toggleDetail(id){
    const li = document.getElementById(id); if(!li) return;
    li.classList.toggle('collapsed');
    const block = li.querySelector('.detail-block');
    if(block){ block.style.display = (block.style.display==='none') ? '' : 'none'; }
}

/* -------------------- è¼‰å…¥æ™‚åˆå§‹åŒ– -------------------- */
window.addEventListener('load', function(){
    if(document.getElementById('apiKey').value.startsWith('sk-ant-api03-')){
        apiKey = document.getElementById('apiKey').value;
        showApiStatus('âœ… APIå¯†é‘°å·²è‡ªå‹•è¼‰å…¥ï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨AIåˆ†æåŠŸèƒ½', 'success');
    }
    updateAnalyzeButton();
});
</script>
</body>
</html>
